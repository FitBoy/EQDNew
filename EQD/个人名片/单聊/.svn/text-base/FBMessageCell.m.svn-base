//
//  FBMessageCell.m
//  EQD
//
//  Created by 梁新帅 on 2017/4/30.
//  Copyright © 2017年 FitBoy. All rights reserved.
//
#define DEVICE_HEIGHT  [UIScreen mainScreen].bounds.size.height
#define DEVICE_WIDTH   [UIScreen mainScreen].bounds.size.width
#import "FBMessageCell.h"
#import "FBGeRenCardMessageContent.h"
#import <UIImageView+AFNetworking.h>
@implementation FBMessageCell


- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        [self initialize];
    }
    return self;
}

- (id)initWithCoder:(NSCoder *)aDecoder {
    self = [super initWithCoder:aDecoder];
    if (self) {
        [self initialize];
    }
    return self;
}

-(void)setModel:(RCMessageModel *)model
{
    [super  setModel:model];
    CGRect rect =self.messageContentView.frame;
    CGSize size =rect.size;
    
    //拉伸图片
    if (MessageDirection_RECEIVE == model.messageDirection) {
        self.bubbleBackgroundView.frame =CGRectMake(0, 0, size.width, size.height);
        self.IV_headimg.frame=CGRectMake(10, 5, 50, 50);
        self.L_name.frame=CGRectMake(70, 5, size.width-70, 25);
        self.L_company.frame=CGRectMake(70, 30, size.width-70, 25);
        self.L_mingpian.frame =CGRectMake(7, 61, size.width-7, 15);
        
        //        chat_from_bg_normal
        
        UIImage *image = [RCKitUtility imageNamed:@"chat_from_bg_normal"
                                         ofBundle:@"RongCloud.bundle"];
        self.bubbleBackgroundView.image = [image
                                           resizableImageWithCapInsets:UIEdgeInsetsMake(image.size.height * 0.8,
                                                                                        image.size.width * 0.8,
                                                                                        image.size.height * 0.2,
                                                                                        image.size.width * 0.2)];
        [image stretchableImageWithLeftCapWidth:20 topCapHeight:20];
        
        
    } else {
        
        self.bubbleBackgroundView.frame =CGRectMake(0, 0, size.width, size.height);
        self.IV_headimg.frame=CGRectMake(10, 5, 50, 50);
        self.L_name.frame=CGRectMake(70, 5, size.width-77, 25);
        self.L_company.frame=CGRectMake(70, 30, size.width-70, 25);
        self.L_mingpian.frame =CGRectMake(0, 61, size.width-7, 15);
        
        
        //   chat_to_bg_normal
        UIImage *image = [RCKitUtility imageNamed:@"chat_to_bg_normal"
                                         ofBundle:@"RongCloud.bundle"];
        self.bubbleBackgroundView.image = [image
                                           resizableImageWithCapInsets:UIEdgeInsetsMake(image.size.height * 0.8,
                                                                                        image.size.width * 0.2,
                                                                                        image.size.height * 0.2,
                                                                                        image.size.width * 0.8)];
        [image stretchableImageWithLeftCapWidth:20 topCapHeight:20];
    }
    
    FBGeRenCardMessageContent *testMessage = (FBGeRenCardMessageContent *)self.model.content;
    if (testMessage) {
        NSDictionary *dic =testMessage.content;
        if ([dic[@"comid"] integerValue]==0) {
            self.L_name.text =dic[@"name"];
        }
        else
        {
            self.L_name.text =[NSString stringWithFormat:@"%@-%@",dic[@"name"],dic[@"bumen"]];
            self.L_company.text = dic[@"company"];
        }
    }

    
    
    
    
    
    
    FBGeRenCardMessageContent *model1 = (FBGeRenCardMessageContent*)model.content;
    NSDictionary *dic =model1.content;
    [self.IV_headimg setImageWithURL:[NSURL URLWithString:dic[@"imgurl"]] placeholderImage:[UIImage imageNamed:@"geren"]];
    
}

+ (CGSize)sizeForMessageModel:(RCMessageModel *)model
      withCollectionViewWidth:(CGFloat)collectionViewWidth
         referenceExtraHeight:(CGFloat)extraHeight
{
    
    
    return CGSizeMake(collectionViewWidth, 66+extraHeight) ;
    
}
- (void)initialize {
    self.bubbleBackgroundView = [[UIImageView alloc] initWithFrame:CGRectZero];
    [self.messageContentView addSubview:self.bubbleBackgroundView];
    self.IV_headimg =[[UIImageView alloc]init];
    self.IV_headimg.layer.masksToBounds = YES;
    self.IV_headimg.layer.cornerRadius=25;
    [self.messageContentView addSubview:self.IV_headimg];
    self.L_name = [[UILabel alloc]init];
    self.L_name.font=[UIFont systemFontOfSize:15];
    [self.messageContentView addSubview:self.L_name];
    
    self.L_company=[[UILabel alloc]init];
    [self.messageContentView addSubview:self.L_company];
    self.L_company.font=[UIFont systemFontOfSize:12];
    self.L_mingpian =[[UILabel alloc]init];
    self.L_mingpian.font=[UIFont systemFontOfSize:12];
    self.L_mingpian.text = @"   易企点名片";
    self.L_mingpian.textColor = [UIColor grayColor];
    self.L_mingpian.layer.borderColor=[UIColor grayColor].CGColor;
    self.L_mingpian.layer.borderWidth=0.3;
    [self.messageContentView addSubview:self.L_mingpian];
    
    self.bubbleBackgroundView.userInteractionEnabled = YES;
    UILongPressGestureRecognizer *longPress =
    [[UILongPressGestureRecognizer alloc]
     initWithTarget:self
     action:@selector(longPressed:)];
    [self.bubbleBackgroundView addGestureRecognizer:longPress];
    
    UITapGestureRecognizer *textMessageTap = [[UITapGestureRecognizer alloc]
                                              initWithTarget:self
                                              action:@selector(tapTextMessage:)];
    textMessageTap.numberOfTapsRequired = 1;
    textMessageTap.numberOfTouchesRequired = 1;
    
    
}

- (void)tapTextMessage:(UIGestureRecognizer *)gestureRecognizer {
    if ([self.delegate respondsToSelector:@selector(didTapMessageCell:)]) {
        [self.delegate didTapMessageCell:self.model];
    }
}




- (void)longPressed:(id)sender {
    UILongPressGestureRecognizer *press = (UILongPressGestureRecognizer *)sender;
    if (press.state == UIGestureRecognizerStateEnded) {
        return;
    } else if (press.state == UIGestureRecognizerStateBegan) {
        [self.delegate didLongTouchMessageCell:self.model
                                        inView:self.bubbleBackgroundView];
    }
}


@end
