//
//  FBQunChatViewController.m
//  EQD
//
//  Created by 梁新帅 on 2017/4/10.
//  Copyright © 2017年 FitBoy. All rights reserved.
//

#import "FBQunChatViewController.h"
#import "FBActivityViewController.h"
#import "ExActivity.h"
#import "QCYDetailViewController.h"
#import "FBGeRenCardMessageContent.h"
#import "FBMessageCell.h"
#import "CardChooseViewController.h"
@interface FBQunChatViewController ()<RCIMGroupMemberDataSource>
{
    
     RCMessageModel  *M_model;
    UserModel *user;
    NSMutableArray *arr1;
}

@end

@implementation FBQunChatViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    arr1=[NSMutableArray arrayWithCapacity:0];
    user =[WebRequest GetUserInfo];
    self.view.backgroundColor =[UIColor whiteColor];
//    self.displayConversationTypeArray = @[@(ConversationType_PRIVATE),@(ConversationType_GROUP)];
    self.conversationType = ConversationType_GROUP;
    self.enableUnreadMessageIcon =YES;
    self.displayUserNameInCell=YES;
    self.enableNewComingMessageIcon=YES;
    [RCIM sharedRCIM].enableTypingStatus =YES;
    [RCIM sharedRCIM].enableSyncReadStatus=YES;
    //@的设置
    [RCIM sharedRCIM].enableMessageMentioned=YES;

    
    UIBarButtonItem *right = [[UIBarButtonItem alloc]initWithImage:[[UIImage imageNamed:@"qun"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] style:UIBarButtonItemStylePlain target:self action:@selector(QunDetailClick)];
    [self.navigationItem setRightBarButtonItem:right];
    [RCIM sharedRCIM].groupMemberDataSource=self;
    
    [self.chatSessionInputBarControl.pluginBoardView insertItemWithImage:[UIImage imageNamed:@"renwu.png"] title:@"发任务" atIndex:5 tag:4001];
    [self.chatSessionInputBarControl.pluginBoardView insertItemWithImage:[RCKitUtility imageNamed:@"card.png" ofBundle:@"RongCloud.bundle"] title:@"个人名片" atIndex:6 tag:4002];
    [self notifyUpdateUnreadMessageCount];
    
    
    [[RCIM sharedRCIM] registerMessageType:[FBGeRenCardMessageContent class]];
    [self.conversationMessageCollectionView registerClass:[FBMessageCell class] forCellWithReuseIdentifier:@"FBMessageBaseCell"];
    [self registerClass:[FBMessageCell class] forMessageClass:[FBGeRenCardMessageContent class]];
    
}
//、扩展功能
-(void)pluginBoardView:(RCPluginBoardView*)pluginBoardView
    clickedItemWithTag:(NSInteger)tag{
    [super pluginBoardView:pluginBoardView clickedItemWithTag:tag];
    switch (tag) {
        case 4001:
        {
            //发任务
        }
            break;
        case 4002:
        {
            
            [WebRequest User_SelectGroupInfoWithgroupname:@"" groupid:self.targetId And:^(NSDictionary *dic) {
                NSNumber *number = dic[@"status"];
                if ([number integerValue]==200) {
                    NSArray *arr = dic[@"items"];
                    if (arr.count) {
                        NSDictionary *dic1 =arr[0];
                    QunModel * model = [QunModel mj_objectWithKeyValues:dic1];
                        
                        CardChooseViewController *Cvc =[[CardChooseViewController alloc]init];
                        Cvc.qunmodel = model;
                        Cvc.isQun=YES;
                        dispatch_async(dispatch_get_main_queue(), ^{
                            [self.navigationController pushViewController:Cvc animated:NO];
                        });

                    }
                }
            }];
            
        }
            break;
            
        default:
            break;
    }
    
}




//群组红包设置 音视频群成员设置
-(void)getAllMembersOfGroup:(NSString *)groupId result:(void (^)(NSArray<NSString *> *))resultBlock
{
    
    groupId =self.targetId;
    if(arr1.count)
    {
        resultBlock(arr1);
    }
    else
    {
    [arr1 removeAllObjects];
        [WebRequest User_SelectGroupMemberWithgroupid:self.targetId And:^(NSDictionary *dic) {
        [arr1 removeAllObjects];
        NSNumber *number =dic[@"status"];
        NSArray *arr =dic[@"items"];
        if ([number integerValue]==200 ) {
            if(arr.count)
            {
                for (NSDictionary *dic1 in arr) {
                    NSString *uname = dic1[@"uname"];
                    [arr1 addObject:uname];
                }
            }
            resultBlock(arr1);
        }
    }];
    }
    
}

-(void)QunDetailClick
{
    //群设置
    QCYDetailViewController *Dvc =[[QCYDetailViewController alloc]init];
    Dvc.qunid = self.targetId;
    Dvc.qunname =self.navigationItem.title;
    [self.navigationController pushViewController:Dvc animated:NO];
    
    
    
}
//长按的列表显示
- (NSArray<UIMenuItem *> *)getLongTouchMessageCellMenuList:(RCMessageModel *)model
{
    
    NSMutableArray<UIMenuItem *> *menuList =
    [[super getLongTouchMessageCellMenuList:model] mutableCopy];
    M_model = model;
    [menuList addObject:[[UIMenuItem alloc] initWithTitle:@"转发"
                                                   action:@selector(zhuanfaClick)]];
    [menuList addObject:[[UIMenuItem alloc] initWithTitle:@"转入记事本"
                                                   action:@selector(jishibenClick)]];
    [menuList addObject:[[UIMenuItem alloc] initWithTitle:@"转入任务"
                                                   action:@selector(renwuClick)]];
    [menuList addObject:[[UIMenuItem alloc] initWithTitle:@"收藏"
                                                   action:@selector(shoucangClick)]];
    [menuList addObject:[[UIMenuItem alloc] initWithTitle:@"更多"
                                                   action:@selector(moreClick)]];
    return menuList;
}
-(void)zhuanfaClick
{
    //转发
    //  RCVoiceMessage RCTextMessage RCImageMessage RCFileMessage
    
    ExActivity *activity = [[ExActivity alloc]init];
    activity.messageContent = M_model.content;
    
    if ([M_model.content isKindOfClass:[RCTextMessage class]]) {
        RCTextMessage *message =(RCTextMessage*) M_model.content;
        FBActivityViewController *ACvc =[[FBActivityViewController alloc]initWithActivityItems:@[message.content] applicationActivities:@[activity]];
        
        [self  presentViewController:ACvc animated:NO completion:nil];
    }
    else if([M_model.content isKindOfClass:[RCImageMessage class]])
    {
        RCImageMessage *message =(RCImageMessage*) M_model.content;
        UIImage *image =[[UIImage alloc]initWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:message.imageUrl]]];
        FBActivityViewController *ACvc =[[FBActivityViewController alloc]initWithActivityItems:@[image] applicationActivities:@[activity]];
        
        [self  presentViewController:ACvc animated:NO completion:nil];
    }
    else if([M_model.content isKindOfClass:[RCFileMessage class]])
    {
        RCFileMessage *message =(RCFileMessage*) M_model.content;
        FBActivityViewController *ACvc =[[FBActivityViewController alloc]initWithActivityItems:@[[NSURL URLWithString:message.fileUrl]] applicationActivities:@[activity]];
        [self  presentViewController:ACvc animated:NO completion:nil];
    }
        else if([M_model.content isKindOfClass:[RCVoiceMessage class]])
        {
            RCVoiceMessage *message =(RCVoiceMessage*) M_model.content;
            FBActivityViewController *ACvc =[[FBActivityViewController alloc]initWithActivityItems:@[message.wavAudioData] applicationActivities:@[activity]];
            [self  presentViewController:ACvc animated:NO completion:nil];
        }
    else
    {
        FBActivityViewController *ACvc =[[FBActivityViewController alloc]initWithActivityItems:@[@"易企点暂时不支持此消息转发"] applicationActivities:@[activity]];
        [self  presentViewController:ACvc animated:NO completion:nil];
    }
    
    
}
-(void)jishibenClick
{
    //转入记事本
}
-(void)renwuClick
{
    //转入任务
    
}
-(void)shoucangClick
{
    //收藏
}
-(void)moreClick
{
    //更多
}

/*
 点击Cell中头像的回调
 
 @param userId  点击头像对应的用户ID
 */
- (void)didTapCellPortrait:(NSString *)userId{
    
}


- (void)didSendMessage:(NSInteger)status
               content:(RCMessageContent *)messageContent
{
    //消息发送完回调   转发也是同样的逻辑
    [super didSendMessage:status content:messageContent];
    
}


-(void)leftBarButtonItemPressed:(id)sender
{
    [super leftBarButtonItemPressed:sender];
    [self.navigationController  popViewControllerAnimated:NO];
}


- (RCMessageBaseCell *)rcConversationCollectionView:(UICollectionView *)collectionView
                             cellForItemAtIndexPath:(NSIndexPath *)indexPath{
    [super rcConversationCollectionView:collectionView cellForItemAtIndexPath:indexPath];
    
    FBMessageCell *cell1 = [collectionView dequeueReusableCellWithReuseIdentifier:@"FBMessageBaseCell" forIndexPath:indexPath];
    RCMessageModel *model =self.conversationDataRepository[indexPath.row];
    if([model.content isKindOfClass:[FBGeRenCardMessageContent class]])
    {
         [cell1 setModel:model];
    }
   
    
    
    return cell1;
}



-(void)willDisplayMessageCell:(RCMessageBaseCell *)cell atIndexPath:(NSIndexPath *)indexPath
{
    if ([cell isKindOfClass:[FBMessageCell class]]) {
        FBMessageCell *cell0 = (FBMessageCell*)cell;
        RCMessageModel *model =self.conversationDataRepository[indexPath.row];
        [cell0 setModel:model];
        
    }
}


- (CGSize)rcConversationCollectionView:(UICollectionView *)collectionView
                                layout:(UICollectionViewLayout *)collectionViewLayout
                sizeForItemAtIndexPath:(NSIndexPath *)indexPath{
    CGSize size =[super rcConversationCollectionView:collectionView layout:collectionViewLayout sizeForItemAtIndexPath:indexPath];
    size.height+=66;
    
    return size;
}
- (void)notifyUpdateUnreadMessageCount {
    [super notifyUpdateUnreadMessageCount];
    __weak typeof(&*self) __weakself = self;
    int count = [[RCIMClient sharedRCIMClient] getUnreadCount:@[
                                                                @(ConversationType_PRIVATE),
                                                                @(ConversationType_GROUP)
                                                                ]];
    dispatch_async(dispatch_get_main_queue(), ^{
        NSString *backString = nil;
        if (count > 0 && count < 1000) {
            backString = [NSString stringWithFormat:@"返回(%d)", count];
        } else if (count >= 1000) {
            backString = @"返回(...)";
        } else {
            backString = @"返回";
        }
        UIButton *backBtn = [UIButton buttonWithType:UIButtonTypeCustom];
        backBtn.frame = CGRectMake(0, 6, 87, 23);
        UIImageView *backImg = [[UIImageView alloc]
                                initWithImage:[UIImage imageNamed:@"navigator_btn_back"]];
        backImg.frame = CGRectMake(-6, 4, 10, 17);
        [backBtn addSubview:backImg];
        UILabel *backText =
        [[UILabel alloc] initWithFrame:CGRectMake(9, 4, 85, 17)];
        backText.text = backString; // NSLocalizedStringFromTable(@"Back",
        // @"RongCloudKit", nil);
        //   backText.font = [UIFont systemFontOfSize:17];
        [backText setBackgroundColor:[UIColor clearColor]];
        [backText setTextColor:EQDCOLOR];
        [backBtn addSubview:backText];
        [backBtn addTarget:__weakself
                    action:@selector(leftBarButtonItemPressed:)
          forControlEvents:UIControlEventTouchUpInside];
        UIBarButtonItem *leftButton =
        [[UIBarButtonItem alloc] initWithCustomView:backBtn];
        [__weakself.navigationItem setLeftBarButtonItem:leftButton];
    });
}

@end
