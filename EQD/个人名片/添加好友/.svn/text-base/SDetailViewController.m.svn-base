//
//  SDetailViewController.m
//  EQD
//
//  Created by 梁新帅 on 2017/3/31.
//  Copyright © 2017年 FitBoy. All rights reserved.
//

#import "SDetailViewController.h"
#import "FBHaoYouModel.h"
#import <UIImageView+AFNetworking.h>
@interface SDetailViewController ()<UITableViewDelegate,UITableViewDataSource>
{
    UITableView *tableV;
    FBHaoYouModel *model;
    BOOL  isperson;
    NSInteger temp;
}

@end

@implementation SDetailViewController
-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self loadRequestData];
}
-(void)loadRequestData{
    
    
    [WebRequest user_enterWithu1:[USERDEFAULTS objectForKey:Y_Zhanghao] u2:[USERDEFAULTS objectForKey:Y_MIMA] uid:self.friendID And:^(NSDictionary *dic) {
        temp =1;
        NSNumber *number = dic[Y_STATUS];
        NSArray *arr =dic[Y_ITEMS];
        if (arr.count == 0) {
            isperson =NO;
        }
        else
        {
            NSDictionary *dic1 =arr[0];
            model = [FBHaoYouModel mj_objectWithKeyValues:dic1];
            isperson = YES;
        }
        [tableV reloadData];

    }];
    
    
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    self.navigationItem.title = @"详细资料";
    temp=0;
    UIBarButtonItem *right = [[UIBarButtonItem alloc]initWithTitle:@"添加好友" style:UIBarButtonItemStylePlain target:self action:@selector(tianjiaClick)];
    
    [self.navigationItem setRightBarButtonItem:right];
    
    tableV = [[UITableView alloc]initWithFrame:CGRectMake(0, 0, DEVICE_WIDTH, DEVICE_HEIGHT) style:UITableViewStylePlain];
    tableV.delegate=self;
    tableV.dataSource=self;
    [self.view addSubview:tableV];
    tableV.rowHeight=60;

}
#pragma  mark - 表的数据源
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return temp;
}
-(UITableViewCell*)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    static NSString *cellId=@"cellID";
    UITableViewCell *cell =[tableView dequeueReusableCellWithIdentifier:cellId];
    if (!cell) {
        cell = [[UITableViewCell alloc]initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:cellId];
        
    }
    if (isperson==NO) {
        cell.textLabel.text = @"该账号未注册易企点";
        self.navigationItem.rightBarButtonItem.title = @"邀请注册";
    }
    else
    {
        
    self.navigationItem.rightBarButtonItem.title = @"添加好友";
    if ([model.iphoto isEqualToString:@"0"]) {
        cell.imageView.image =[UIImage imageNamed:@"no_login_head"];
    }
    else
    {
        [cell.imageView setImageWithURL:[NSURL URLWithString:model.iphoto]];
    }
    NSString *name = @"游客";
    if (![model.name isEqualToString:@"0"] ) {
        name=model.pname;
    }
       NSString *Sex =@"男";
    if (!(model.sex==0)) {
        Sex = @"女";
    }
    cell.textLabel.text =[NSString stringWithFormat:@"%@   %@",name,Sex];
    cell.detailTextLabel.text =[NSString stringWithFormat:@"易企点账号：%@",model.uname];
    }
    
    return cell;
}



-(void)tianjiaClick{
    
    if(isperson == NO)
    {
        //发邮件邀请注册  或者发短信邀请注册
        UIAlertController *alert1 =[UIAlertController alertControllerWithTitle:nil message:[NSString stringWithFormat:@"您将要邀请%@注册易企点",self.friendID] preferredStyle:UIAlertControllerStyleAlert];
        [alert1 addTextFieldWithConfigurationHandler:^(UITextField * _Nonnull textField) {
            textField.placeholder = [NSString stringWithFormat:@"说些您想对%@说的话",self.friendID];
        }];
        [alert1 addAction:[UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            
        }]];
        [alert1 addAction:[UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
            [self.navigationController popToViewController:self.navigationController.viewControllers[0] animated:NO];
        }]];
        [self presentViewController:alert1 animated:NO completion:nil];
        
    }
    
    else
    {
    UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil message:[NSString stringWithFormat:@"您将要添加%@为好友",self.friendID] preferredStyle:UIAlertControllerStyleAlert];
    [alert addTextFieldWithConfigurationHandler:^(UITextField * _Nonnull textField) {
        textField.placeholder = @"我是……(验证信息)";
    }];
        
        [alert addAction:[UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
           
        }]];

    [alert addAction:[UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        NSString *str = [USERDEFAULTS objectForKey:Y_Zhanghao];
        NSString *content = alert.textFields[0].text;
        
        UserModel *model1 = [WebRequest GetUserInfo];
        
        FBLoadingEffectView *effectV =[[FBLoadingEffectView alloc]init];
        [self.view addSubview:effectV];
        effectV.L_title.text =@"正在发送";
        
        [WebRequest User_AddFriendWithuserid:str friendid:self.friendID content:content iphoto:model1.iphoto And:^(NSDictionary *dic) {
            [effectV cancelView];
            NSString *msg = dic[Y_MSG];
            NSNumber *number = dic[Y_STATUS];
            if ([number integerValue]==200) {
                MBFadeAlertView *alert = [[MBFadeAlertView alloc]init];
                [alert showAlertWith:@"已发送好友邀请"];
            }
            else
            {
                MBFadeAlertView *alert = [[MBFadeAlertView alloc]init];
                [alert showAlertWith:msg];
            }
            
            [self.navigationController popToViewController:self.navigationController.viewControllers[0] animated:NO];
        }];
        
        
    }]];
           [self presentViewController:alert animated:NO completion:nil];
    }
    
}

-(void)viewWillDisappear:(BOOL)animated
{
    temp=0;
}

@end
