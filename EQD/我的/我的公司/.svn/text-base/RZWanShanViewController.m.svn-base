//
//  RZWanShanViewController.m
//  EQD
//
//  Created by 梁新帅 on 2017/4/26.
//  Copyright © 2017年 FitBoy. All rights reserved.
//

#import "RZWanShanViewController.h"
#import "FBTextFieldViewController.h"
#import "FBAddressViewController.h"
#import "FBOptionViewController.h"
#import <RongIMKit/RongIMKit.h>
@interface RZWanShanViewController ()<UITableViewDelegate,UITableViewDataSource,FBTextFieldViewControllerDelegate,FBAddressViewControllerDelegate,FBOptionViewControllerDelegate>
{
    UITableView *tableV;
    NSMutableArray *arr_names;
    NSMutableDictionary *dic2;
    NSMutableArray *arr_key;
    //是否显示网络请求来的数据
    NSInteger temp ;
}

@end

@implementation RZWanShanViewController
-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self loadRequestData];
}
-(void)loadRequestData{
    
    [WebRequest Com_SelectStaffInfoWithuid:[USERDEFAULTS objectForKey:Y_Zhanghao] pass:[USERDEFAULTS objectForKey:Y_MIMA] And:^(NSDictionary *dic) {
        if ([dic[Y_STATUS] integerValue]==200) {
            NSArray *arr =dic[Y_ITEMS];
            
            temp=1;
            if (arr.count) {
               dic2 = [NSMutableDictionary dictionaryWithDictionary:arr[0]];
            }
            
        }
        [tableV reloadData];
        
    }];
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    temp =0;
    self.navigationItem.title=@"请先完善个人信息";
    arr_names =[NSMutableArray arrayWithArray:@[@"身高",@"体重",@"血型",@"生肖",@"信仰",@"现住址",@"婚否",@"紧急联系人姓名",@"紧急联系人关系",@"紧急联系人电话",@"毕业院校",@"学历",@"职业资格",@"外语等级",@"政治面貌",@"社会保险号",@"所学专业",@"兴趣爱好(可选)",@"qq(可选)",@"微信(可选)"]];
    
    arr_key = [NSMutableArray arrayWithArray:@[@"heigh",@"weigh",@"blood",@"czodia",@"belief",@"padress",@"marry",@"contactname",@"contactrelat",@"contacttel",@"grad",@"edu",@"pskill",@"foreighclass",@"politicstate",@"socialsecuritynum",@"major",@"interests",@"qq",@"wchat"]];

    tableV = [[UITableView alloc]initWithFrame:CGRectMake(0, 0, DEVICE_WIDTH, DEVICE_HEIGHT) style:UITableViewStylePlain];
    tableV.delegate=self;
    tableV.dataSource=self;
    [self.view addSubview:tableV];
    tableV.rowHeight=50;
    UIBarButtonItem *right = [[UIBarButtonItem alloc]initWithTitle:@"提交" style:UIBarButtonItemStylePlain target:self action:@selector(tijiaoClick)];
    [self.navigationItem setRightBarButtonItem:right];
}
-(void)tijiaoClick
{
    NSInteger falg =0;
    for (int i=0; i<16; i++) {
        NSString *str =arr_key[i];
        NSString *key_str =[NSString stringWithFormat:@"%@",dic2[str]];
        if (key_str.length==0) {
            falg =1;
            break;
        }
    }
    if (falg ==0) {
        
        if(self.comid.length==0)
        {
           //接受邀请
            MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
            hud.mode = MBProgressHUDModeAnnularDeterminate;
            hud.label.text = @"正在加入企业";
            [WebRequest Com_SetPersonnelWithuid:[USERDEFAULTS objectForKey:Y_Zhanghao] cid:self.model.icomid post:self.model.iepostnum status:@"1" And:^(NSDictionary *dic) {
                
                if ([dic[Y_STATUS] integerValue]==200) {
               [WebRequest Com_GetSimpleInfoWithcid:self.model.icomid And:^(NSDictionary *dic) {
                   dispatch_async(dispatch_get_main_queue(), ^{
                     [hud hideAnimated:NO];
                   });
                   
                   NSNumber *status =dic[Y_STATUS];
                   NSArray  *arr = dic[Y_ITEMS];
                   if ([status integerValue]==200) {
                       NSDictionary *dic1 =arr[0];
                       [USERDEFAULTS setObject:dic1 forKey:Y_Company];
                       [USERDEFAULTS synchronize];
                      [self.navigationController popToRootViewControllerAnimated:NO];
                   }
               }];
                    
                    
                    
                }
                else
                {
                    MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
                    hud.mode = MBProgressHUDModeText;
                    hud.label.text =@"网络问题，加入企业失败";
                    dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
                    dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                        [MBProgressHUD hideHUDForView:self.view  animated:YES];
                    });
                }
                
            }];
        }
        else
        {
        MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.label.text =@"信息已提交，等待人事通过";
        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
            [MBProgressHUD hideHUDForView:self.view  animated:YES];
            
            [self.navigationController popToViewController:self.navigationController.viewControllers[0] animated:YES];
            
        });
        }
}
    else
    {
        MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.label.text =@"信息填写不完整";
        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
            [MBProgressHUD hideHUDForView:self.view animated:YES];
        });
    }
    
    
}
#pragma  mark - 表的数据源
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return arr_names.count;
}
-(UITableViewCell*)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    static NSString *cellId=@"cellID";
    UITableViewCell *cell =[tableView dequeueReusableCellWithIdentifier:cellId];
    if (!cell) {
        cell = [[UITableViewCell alloc]initWithStyle:UITableViewCellStyleValue1 reuseIdentifier:cellId];
        cell.accessoryType = UITableViewCellAccessoryDisclosureIndicator;
    }
    cell.textLabel.text =arr_names[indexPath.row];
    if (temp==0) {
        cell.detailTextLabel.text=nil;
    }
    else
    {
        NSString *key =arr_key[indexPath.row];
        cell.detailTextLabel.text =[NSString stringWithFormat:@"%@",dic2[key]];
    }

    return cell;
}

#pragma  mark - 表的协议代理
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.row<2 || indexPath.row==4 || (indexPath.row>6 && indexPath.row<11) || indexPath.row==13|| indexPath.row >14) {
        //身高 体重 ……
        FBTextFieldViewController *TFvc =[[FBTextFieldViewController alloc]init];
        TFvc.indexPath=indexPath;
        TFvc.delegate=self;
        TFvc.contentTitle =arr_names[indexPath.row];
        TFvc.content =[NSString stringWithFormat:@"%@",dic2[arr_key[indexPath.row]]] ;
        [self.navigationController pushViewController:TFvc animated:NO];
        
    }
    else if(indexPath.row==2)
    {
        //血型
        UIAlertController *alert =[[UIAlertController alloc]init];
        [alert addAction:[UIAlertAction actionWithTitle:@"A" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self xiugaiWithcongtent:action.title indexpath:indexPath];
        }]];
        [alert addAction:[UIAlertAction actionWithTitle:@"B" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self xiugaiWithcongtent:action.title indexpath:indexPath];
        }]];
        [alert addAction:[UIAlertAction actionWithTitle:@"AB" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self xiugaiWithcongtent:action.title indexpath:indexPath];
        }]];
        [alert addAction:[UIAlertAction actionWithTitle:@"O" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self xiugaiWithcongtent:action.title indexpath:indexPath];
        }]];
        [self presentViewController:alert animated:NO completion:nil];
        
    }
    else if(indexPath.row==3)
    {
        //生肖
        FBOptionViewController *ovc =[[FBOptionViewController alloc]init];
        ovc.indexPath=indexPath;
        ovc.delegate =self;
        ovc.option=20;
        ovc.contentTitle =arr_names[indexPath.row];
        [self.navigationController pushViewController:ovc animated:NO];
    }
    else if(indexPath.row==5)
    {
        //现住址
        FBAddressViewController *Avc =[[FBAddressViewController alloc]init];
        Avc.delegate=self;
        Avc.indexPath =indexPath;
        Avc.isXiangXi=YES;
        [self.navigationController pushViewController:Avc animated:NO];
    }
    else if(indexPath.row==6)
    {
        //婚配
        FBOptionViewController *Ovc =[[FBOptionViewController alloc]init];
        Ovc.indexPath=indexPath;
        Ovc.delegate=self;
        Ovc.option=3;
        Ovc.contentTitle =arr_names[indexPath.row];
        [self.navigationController pushViewController:Ovc animated:NO];

    }
    else if(indexPath.row==11)
    {
        //学历
        FBOptionViewController *ovc =[[FBOptionViewController alloc]init];
        ovc.indexPath=indexPath;
        ovc.delegate =self;
        ovc.option=5;
        ovc.contentTitle =arr_names[indexPath.row];
        [self.navigationController pushViewController:ovc animated:NO];
    }
    else if(indexPath.row==12)
    {
        //职业资格
        FBOptionViewController *ovc =[[FBOptionViewController alloc]init];
        ovc.indexPath=indexPath;
        ovc.delegate =self;
        ovc.option=6;
        ovc.contentTitle =arr_names[indexPath.row];
        [self.navigationController pushViewController:ovc animated:NO];
    }
    else if(indexPath.row==14)
    {
        //政治面貌
        FBOptionViewController *ovc =[[FBOptionViewController alloc]init];
        ovc.indexPath=indexPath;
        ovc.delegate =self;
        ovc.option=4;
        ovc.contentTitle =arr_names[indexPath.row];
        [self.navigationController pushViewController:ovc animated:NO];
    }
   else
   {
       
   }
    
    
}

-(void)content:(NSString *)content WithindexPath:(NSIndexPath *)indexPath
{
    
    if (indexPath.row==18) {
        //qq
        if ([self  isPureNumandCharacters:content]) {
            if (content.length > 4 && content.length <15) {
                [self xiugaiWithcongtent:content indexpath:indexPath];
            }
            else
            {
                MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
                hud.mode = MBProgressHUDModeText;
                hud.label.text =@"qq的 位数5--14";
                dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
                dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                    [MBProgressHUD hideHUDForView:self.view  animated:YES];
                });
            }
        }
        else
        {
            MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text =@"输入的qq不合法";
            dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
            dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                [MBProgressHUD hideHUDForView:self.view  animated:YES];
            });
        }
        
    }
    
    else if(indexPath.row==9)
    {
        if( [RCKitUtility validateCellPhoneNumber:content])
        {
            [self xiugaiWithcongtent:content indexpath:indexPath];
        }
        else
        {
            MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text =@"手机号格式不正确";
            dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
            dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                [MBProgressHUD hideHUDForView:self.view  animated:YES];
            });
        }

    }
    
    else
    {
        [self xiugaiWithcongtent:content indexpath:indexPath];
    }
    
    

    
}
-(void)address:(NSString *)address Withindexpath:(NSIndexPath *)indexPath
{
    
    [self xiugaiWithcongtent:address indexpath:indexPath];
}
-(void)option:(NSString *)option indexPath:(NSIndexPath *)indexPath
{
    [self xiugaiWithcongtent:option indexpath:indexPath];
}

-(void)xiugaiWithcongtent:(NSString*)content indexpath:(NSIndexPath*)indexpath{
    [WebRequest Com_UpdateStaffInfoWithkey:arr_key[indexpath.row] value:content And:^(NSDictionary *dic) {
        if ([dic[Y_STATUS] integerValue]==200) {
            MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text =@"修改成功";
            dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
            dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                [MBProgressHUD hideHUDForView:self.view  animated:YES];
            });
            [dic2 setObject:content forKey:arr_key[indexpath.row]];
            
            [tableV reloadData];
        }
        else
        {
            MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text =@"未知错误";
            dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
            dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                [MBProgressHUD hideHUDForView:self.view  animated:YES];
            });
        }
        
    }];
    
}


@end
