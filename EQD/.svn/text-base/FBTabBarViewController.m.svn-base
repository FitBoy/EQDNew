//
//  FBTabBarViewController.m
//  EQD
//
//  Created by 梁新帅 on 2017/3/18.
//  Copyright © 2017年 FitBoy. All rights reserved.
//

#import "FBTabBarViewController.h"
#import "WebRequest.h"
#import <JPUSHService.h>
#import <RongIMKit/RongIMKit.h>

@interface FBTabBarViewController ()
{
    UserModel *user;
    UINavigationController *nav1;
    
}

@end

@implementation FBTabBarViewController
-(void)viewWillAppear:(BOOL)animated{
    
    [super viewWillAppear:animated];
    int unread_numm= [[RCIMClient sharedRCIMClient]getUnreadCount:@[@(ConversationType_PRIVATE),@(ConversationType_GROUP)]];
   
    if (unread_numm==0) {
        nav1.tabBarItem.badgeValue= nil;
    }
    else
    {
    nav1.tabBarItem.badgeValue= [NSString stringWithFormat:@"%d",unread_numm];
    }
    [self loadRequestData];
}
-(void)loadRequestData{
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    NSNotificationCenter *defaultCenter = [NSNotificationCenter defaultCenter];
    user =[WebRequest GetUserInfo];
    [defaultCenter addObserver:self
                      selector:@selector(networkDidLogin:)
                          name:kJPFNetworkDidLoginNotification
                        object:nil];
    NSString  *token1 = [USERDEFAULTS objectForKey:RC_TOKEN];
    if (token1) {
        [self connectRCWithToken:token1];
    }
    else
    {
        RCUserInfo  *userinfo =[[RCUserInfo alloc]initWithUserId:user.Guid name:user.upname portrait:user.iphoto];
        [self loginRCWithuserifo:userinfo];
    
    }
    
   
    
    [self initViewControllers];
  
    
}

-(void)initViewControllers
{
   FBOneViewController *onevc =[[FBOneViewController alloc]init];
    nav1 =[[UINavigationController alloc]initWithRootViewController:onevc];
    UIImage  *image1 =[[UIImage imageNamed:@"xiaoxi"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal];
    UIImage *selectedImage1 =[[UIImage imageNamed:@"xiaoxi_focu"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal];
    onevc.tabBarItem = [[UITabBarItem alloc]initWithTitle:@"消息" image:image1 selectedImage:selectedImage1];
    
    
    FBTwoViewController  *twovc =[[FBTwoViewController alloc]init];
    UINavigationController *nav2 =[[UINavigationController alloc]initWithRootViewController:twovc];
    twovc.tabBarItem = [[UITabBarItem alloc]initWithTitle:@"通讯录" image:[[UIImage imageNamed:@"tongxunlu"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] selectedImage:[[UIImage imageNamed:@"tongxunlu_focu"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal]];
    
    FBThreeViewController *threevc =[[FBThreeViewController alloc]init];
    UINavigationController *nav3 =[[UINavigationController alloc]initWithRootViewController:threevc];
    threevc.tabBarItem =[[UITabBarItem alloc]initWithTitle:@"功能" image:[[UIImage imageNamed:@"add_focus"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] selectedImage:[[UIImage imageNamed:@"add"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal]];
    
    FBFourViewController *fourvc =[[FBFourViewController alloc]init];
    UINavigationController *nav4 =[[UINavigationController alloc]initWithRootViewController:fourvc];
    fourvc.tabBarItem = [[UITabBarItem alloc]initWithTitle:@"发现" image:[[UIImage imageNamed:@"faxian"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] selectedImage:[[UIImage imageNamed:@"faxian_focu"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal]];;
    
    FBFiveViewController *fivevc =[[FBFiveViewController alloc]init];
    UINavigationController *nav5 =[[UINavigationController alloc]initWithRootViewController:fivevc];
    fivevc.tabBarItem = [[UITabBarItem alloc]initWithTitle:@"我的" image:[[UIImage imageNamed:@"me"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] selectedImage:[[UIImage imageNamed:@"me_focu"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal]];
    
   self.viewControllers = @[nav1,nav2,nav3,nav4,nav5];
    self.selectedIndex=2;
}


-(void)loginRCWithuserifo:(RCUserInfo*)userinfo{
    
    [WebRequest User_RyHttpClientWithuserId:userinfo.userId name:userinfo.name portraitUri:userinfo.portraitUri And:^(NSDictionary *dic) {
        NSNumber *number = dic[@"code"];
        if ([number integerValue]==200) {
            NSString *token = dic[@"token"];
            [USERDEFAULTS setObject:token forKey:RC_TOKEN];
            [USERDEFAULTS synchronize];
            [self connectRCWithToken:token];
        }
        else
        {
            RCUserInfo  *userinfo =[[RCUserInfo alloc]initWithUserId:user.Guid name:user.upname portrait:user.iphoto];
            [self loginRCWithuserifo:userinfo];
        }

    }];
    
  
}

-(void)connectRCWithToken:(NSString*)token2{
    
  UserModel *user = [WebRequest GetUserInfo];
    [[RCIM sharedRCIM] connectWithToken:token2 success:^(NSString *userId) {
        NSLog(@"登录的userid===%@",userId);
                RCUserInfo  *userinfo =[[RCUserInfo alloc]initWithUserId:userId name:user.upname portrait:user.iphoto];
        [RCIM sharedRCIM].enableMessageAttachUserInfo=YES;
        [RCIM sharedRCIM].currentUserInfo=userinfo;
        [RCIM sharedRCIM].globalConversationAvatarStyle=RC_USER_AVATAR_CYCLE;
        [RCIM sharedRCIM].globalMessageAvatarStyle=RC_USER_AVATAR_CYCLE;
        [RCIM sharedRCIM].enableMessageAttachUserInfo=YES;
        
    } error:^(RCConnectErrorCode status) {
          RCUserInfo  *userinfo =[[RCUserInfo alloc]initWithUserId:user.Guid name:user.upname portrait:user.iphoto];
        [self loginRCWithuserifo:userinfo];
        
    } tokenIncorrect:^{
        
    }];
}


- (void)networkDidLogin:(NSNotification *)notification {
    
    [JPUSHService setAlias:user.Guid completion:^(NSInteger iResCode, NSString *iAlias, NSInteger seq) {
        NSLog(@"iResCode==%ld=iAlias==%@seq==%ld",(long)iResCode,iAlias,(long)seq);
    } seq:2017];
    
    if([user.companyId integerValue]!=0)
    {
        [JPUSHService setTags:[NSSet setWithArray:@[[NSString stringWithFormat:@"%@_0",user.companyId],[NSString stringWithFormat:@"%@_%@",user.companyId,user.departId]]] completion:^(NSInteger iResCode, NSSet *iTags, NSInteger seq) {
            NSLog(@"tag值的设定iResCode==%ld=iTags===%@",(long)iResCode,iTags);
        } seq:2017];
        
    }
    
    
}


@end
