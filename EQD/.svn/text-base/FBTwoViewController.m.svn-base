//
//  FBTwoViewController.m
//  EQD
//
//  Created by 梁新帅 on 2017/3/18.
//  Copyright © 2017年 FitBoy. All rights reserved.
//

#import "FBTwoViewController.h"
#import "FBAddFriendViewController.h"
#import "TXLFriendShengQingViewController.h"
#import "TXLQunLiaoViewController.h"
#import "FBNewFriendTableViewCell.h"
#import "FBConversationViewControllerViewController.h"
#import "FBLocationPickerViewController.h"
#import "TAddFriendViewController.h"
#import "BMChineseSort.h"
#import "FBHaoYouModel.h"
#import <UIImageView+AFNetworking.h>
#import "TwoTongShiViewController.h"
#import "FBindexpathLongPressGestureRecognizer.h"
@interface FBTwoViewController ()<UITableViewDelegate,UITableViewDataSource,UISearchBarDelegate>
{
    UITableView *tableV;
    NSMutableArray *arr_one;
    NSMutableArray *arr_two;
    NSMutableArray *tarr;
    UISearchBar *searchBar;
    
    UILabel *L_haoyou;
    NSInteger num_friend;
    
    //排序后的索引与数组
    NSArray  *arr_index;
    NSArray  *arr_name;
    
    
}


@end

@implementation FBTwoViewController
-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self loadRequestData];
}
-(void)loadRequestData{
    
    NSString *zhanghao =[USERDEFAULTS objectForKey:Y_Zhanghao];
    [WebRequest User_GetFriendListuid:zhanghao And:^(NSDictionary *dic) {
        [arr_two removeAllObjects];
        NSNumber *number =dic[@"status"];
        NSArray *arr =dic[@"items"];
        if ([number integerValue]==200 ) {
            if(arr.count)
            {
                for (NSDictionary *dic1 in arr) {
                    FBHaoYouModel *model = [FBHaoYouModel mj_objectWithKeyValues:dic1];
                    [arr_two addObject:model];
                }
                
                
                arr_index = [BMChineseSort IndexWithArray:arr_two Key:@"pname"];
                arr_name = [BMChineseSort sortObjectArray:arr_two Key:@"pname"];
                
            }
            dispatch_async(dispatch_get_main_queue(), ^{
                [tableV.mj_header endRefreshing];
                [tableV reloadData];
            });
        }
    }];
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
   self.navigationItem.title = @"通讯录";
    UIBarButtonItem *right =[[UIBarButtonItem alloc]initWithImage:[[UIImage imageNamed:@"add_eqd2"] imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] style:UIBarButtonItemStyleDone target:self action:@selector(kuaijiefangshi)];
    
    [self.navigationItem setRightBarButtonItem:right];
    self.view.backgroundColor =[UIColor whiteColor];
    
    arr_one=[NSMutableArray arrayWithArray:@[@[@"ease_new_friends_icon.png",@"添加好友"],@[@"mytask.png",@"同事"],@[@"yanzheng.png",@"新的好友"],@[@"ease_groups_icon.png",@"群聊"],@[@"biaoqian.png",@"标签"],@[@"gzh.png",@"企业圈"]]];
    
    arr_two =[NSMutableArray arrayWithCapacity:0];
    tarr =[NSMutableArray arrayWithCapacity:0];
    self.automaticallyAdjustsScrollViewInsets=NO;
    tableV = [[UITableView alloc]initWithFrame:CGRectMake(0, 104, DEVICE_WIDTH, DEVICE_HEIGHT-104-49) style:UITableViewStyleGrouped];
    tableV.delegate=self;
    tableV.dataSource=self;
    [self.view addSubview:tableV];
    tableV.rowHeight=60;
    tableV.mj_header = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(loadRequestData)];
    
    searchBar =[[UISearchBar alloc]initWithFrame:CGRectMake(0, 64, DEVICE_WIDTH, 40)];
    [self.view addSubview:searchBar];
    searchBar.delegate=self;
    searchBar.placeholder=@"快速查找好友";
}

-(void)scrollViewDidScroll:(UIScrollView *)scrollView{
    [self.view endEditing:YES];
}

#pragma  mark - 表的数据源
- (nullable NSArray<NSString *> *)sectionIndexTitlesForTableView:(UITableView *)tableView{
    return arr_index;
}
- (NSInteger)tableView:(UITableView *)tableView sectionForSectionIndexTitle:(NSString *)title atIndex:(NSInteger)index{
    return index-1;
}
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView
{
    return arr_index.count+1;
}
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    if (section==0) {
        return arr_one.count;
    }
    NSArray *arr = arr_name[section-1];
    return arr.count;
}
-(UITableViewCell*)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    if (indexPath.section==0) {
        
        static NSString *cellId=@"cellID";
        UITableViewCell *cell =[tableView dequeueReusableCellWithIdentifier:cellId];
        if (!cell) {
            cell = [[UITableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellId];
            cell.accessoryType = UITableViewCellAccessoryDisclosureIndicator;
            cell.selectionStyle=UITableViewCellSelectionStyleNone;
        }
        NSArray *arr =arr_one[indexPath.row];
        
        cell.imageView.image=[UIImage imageNamed:arr[0]];
        cell.textLabel.text =arr[1];
        return cell;
        
    }
    else
    {
        static NSString *cellId2=@"cellID2";
        FBNewFriendTableViewCell *cell =[tableView dequeueReusableCellWithIdentifier:cellId2];
        if (!cell) {
            cell = [[FBNewFriendTableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellId2];
            cell.B_btn.hidden=YES;
            cell.selectionStyle=UITableViewCellSelectionStyleNone;
        }
        
        NSArray *arr =arr_name[indexPath.section-1];
        FBHaoYouModel *model =arr[indexPath.row];
        FBindexpathLongPressGestureRecognizer  *longpress = [[FBindexpathLongPressGestureRecognizer alloc]initWithTarget:self action:@selector(longpressClick:)];
        longpress.indexPath=indexPath;
        [cell addGestureRecognizer:longpress];
        
        [cell.IV_headimg setImageWithURL:[NSURL URLWithString:model.iphoto] placeholderImage:[UIImage imageNamed:@"no_login_head"]];
        cell.L_name.text=model.pname;
        cell.L_date.text =[NSString stringWithFormat:@"账号：%@",model.uname];
    return cell;
    }
    
}

-(void)longpressClick:(FBindexpathLongPressGestureRecognizer*)longpress
{
    NSArray *arr =arr_name[longpress.indexPath.section-1];
    FBHaoYouModel *model =arr[longpress.indexPath.row];
    UIAlertController *alert = [[UIAlertController alloc]init];
    [alert addAction:[UIAlertAction actionWithTitle:[NSString stringWithFormat:@"拨打电话：%@",model.uname]style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        NSMutableString *str = [[NSMutableString alloc] initWithFormat:@"tel:%@",model.uname];
        UIWebView *callWebView = [[UIWebView alloc] init];
        [callWebView loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:str]]];
        dispatch_async(dispatch_get_main_queue(), ^{
             [self.view addSubview:callWebView];
        });
       
    }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"添加标签"style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        
    }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"删除好友"style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        
        
        UIAlertController *alert2 =[UIAlertController alertControllerWithTitle:nil message:@"确定删除该好友" preferredStyle:UIAlertControllerStyleActionSheet];
        [alert2 addAction:[UIAlertAction actionWithTitle:@"删除" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            NSArray *arr=arr_name[longpress.indexPath.section-1];
            FBHaoYouModel *model = arr[longpress.indexPath.row];
            NSString *uid = [USERDEFAULTS objectForKey:Y_Zhanghao];
            [WebRequest User_DeleteFriendWithuid:uid friendid:model.uname And:^(NSDictionary *dic) {
                NSNumber *number = dic[@"status"];
                if ([number integerValue]==200) {
                    dispatch_async(dispatch_get_main_queue(), ^{
                        MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
                        hud.mode = MBProgressHUDModeText;
                        hud.label.text =@"删除好友成功";
                        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
                        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                            [MBProgressHUD hideHUDForView:self.view  animated:YES];
                        });

                    });
                    
                    
                }
                else
                {
                    dispatch_async(dispatch_get_main_queue(), ^{
                        MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
                        hud.mode = MBProgressHUDModeText;
                        hud.label.text =@"删除好友失败，请重试";
                        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
                        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                            [MBProgressHUD hideHUDForView:self.view  animated:YES];
                        });

                    });
                                    }
                dispatch_async(dispatch_get_main_queue(), ^{
                    [tableV reloadData];
                });
            }];

        }]];
        [alert2 addAction:[UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            
        }]];
        
        [self presentViewController:alert2 animated:NO completion:nil];
        
        
        
    }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"取消"style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
        
    }]];
    
    [self presentViewController:alert animated:NO completion:nil];
}

- (void)searchBar:(UISearchBar *)searchBar textDidChange:(NSString *)searchText{
    
    if (searchText.length==0) {
        arr_two =[NSMutableArray arrayWithArray:tarr];
    }
    else{
        NSPredicate *predicate =[NSPredicate predicateWithFormat:@"name CONTAINS[cd] %@",searchText];
        arr_two = [NSMutableArray arrayWithArray:[tarr filteredArrayUsingPredicate:predicate]];
    }
    [tableV reloadData];
    
    
}
-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    return 15;
}

-(void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    [self.view endEditing:YES];
}
#pragma  mark - 表的协议代理

-(NSString*)tableView:(UITableView *)tableView titleForHeaderInSection:(NSInteger)section

{
    if (section==0) {
        return nil;
    }
    return arr_index[section-1];
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    
    [self.view endEditing:YES];
    if (indexPath.section==0) {
        switch (indexPath.row) {
            case 0:
            {
                NSLog(@"添加好友");
                TAddFriendViewController *AFvc =[[TAddFriendViewController alloc]init];
                AFvc.hidesBottomBarWhenPushed=YES;
                [self.navigationController pushViewController:AFvc animated:NO];
                
                
            }
                break;
            case 1:
            {
                NSLog(@"同事");
                TwoTongShiViewController *TSvc =[[TwoTongShiViewController alloc]init];
                TSvc.hidesBottomBarWhenPushed=YES;
                [self.navigationController pushViewController:TSvc animated:NO];
               
            }
                break;
            case 2:
            {
                NSLog(@"好友申请");
                TXLFriendShengQingViewController *FSvc =[[TXLFriendShengQingViewController alloc]init];
                FSvc.hidesBottomBarWhenPushed =YES;
                [self.navigationController pushViewController:FSvc animated:NO];
                
            }
                break;
                
            case 3:
            {
                NSLog(@"群聊");
                TXLQunLiaoViewController *QLvc =[[TXLQunLiaoViewController alloc]init];
                QLvc.hidesBottomBarWhenPushed =YES;
                [self.navigationController pushViewController:QLvc animated:NO];
            }
                break;
            case 4:
            {
                //标签
                FBSearchMapViewController *SMvc =[[FBSearchMapViewController alloc]init];
                SMvc.hidesBottomBarWhenPushed =YES;
                [self.navigationController pushViewController:SMvc animated:NO];
                
            }
                break;
            case 5:
            {
                NSLog(@"企业圈");
            }
                break;
                
            default:
                break;
        }
    }
    
    else
    {
        NSArray *arr =arr_name[indexPath.section-1];
        FBHaoYouModel *model =arr[indexPath.row];
        
        FBConversationViewControllerViewController  *oneTooneChat =[[FBConversationViewControllerViewController alloc]initWithConversationType:ConversationType_PRIVATE targetId:model.uname];
        oneTooneChat.navigationItem.title =model.pname;
        oneTooneChat.hidesBottomBarWhenPushed =YES;
        [self.navigationController pushViewController:oneTooneChat animated:NO];
    }
    
}



-(void)tableView:(UITableView *)tableView commitEditingStyle:(UITableViewCellEditingStyle)editingStyle forRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (editingStyle ==UITableViewCellEditingStyleDelete) {
        //删除好友
        
        
        UIAlertController *alert2 =[UIAlertController alertControllerWithTitle:nil message:@"确定删除该好友" preferredStyle:UIAlertControllerStyleActionSheet];
        [alert2 addAction:[UIAlertAction actionWithTitle:@"删除" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            NSArray *arr=arr_name[indexPath.section-1];
            FBHaoYouModel *model = arr[indexPath.row];
            NSString *uid = [USERDEFAULTS objectForKey:Y_Zhanghao];
            [WebRequest User_DeleteFriendWithuid:uid friendid:model.uname And:^(NSDictionary *dic) {
                NSNumber *number = dic[@"status"];
                if ([number integerValue]==200) {
                    dispatch_async(dispatch_get_main_queue(), ^{
                        MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
                        hud.mode = MBProgressHUDModeText;
                        hud.label.text =@"删除好友成功";
                        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
                        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                            [MBProgressHUD hideHUDForView:self.view  animated:YES];
                        });
                        
                    });
                    
                    
                }
                else
                {
                    dispatch_async(dispatch_get_main_queue(), ^{
                        MBProgressHUD *hud=[MBProgressHUD showHUDAddedTo:self.view  animated:YES];
                        hud.mode = MBProgressHUDModeText;
                        hud.label.text =@"删除好友失败，请重试";
                        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC);
                        dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
                            [MBProgressHUD hideHUDForView:self.view  animated:YES];
                        });
                        
                    });
                }
                dispatch_async(dispatch_get_main_queue(), ^{
                    [tableV reloadData];
                });
            }];
            
        }]];
        [alert2 addAction:[UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            
        }]];
        
        [self presentViewController:alert2 animated:NO completion:nil];

        
       
        
    }
}
-(UITableViewCellEditingStyle)tableView:(UITableView *)tableView editingStyleForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.section==0) {
        return UITableViewCellEditingStyleNone;
    }
    return UITableViewCellEditingStyleDelete;
}
-(NSString*)tableView:(UITableView *)tableView titleForDeleteConfirmationButtonForRowAtIndexPath:(NSIndexPath *)indexPath
{
    return @"删除";
}
-(BOOL)tableView:(UITableView *)tableView canEditRowAtIndexPath:(NSIndexPath *)indexPath
{
    if (indexPath.section==0) {
        return NO;
    }
    return YES;
}



@end
