//
//  FBOneViewController.m
//  EQD
//
//  Created by 梁新帅 on 2017/3/18.
//  Copyright © 2017年 FitBoy. All rights reserved.
//

#import "FBOneViewController.h"
#import "FBConversationViewControllerViewController.h"
#import "FBQunChatViewController.h"
#import "WebRequest.h"
#import "QunModel.h"
#import <UIImageView+AFNetworking.h>
#import "FBindexpathLongPressGestureRecognizer.h"
@interface FBOneViewController ()<RCIMReceiveMessageDelegate>
{
    NSMutableArray *tarr;
}

@end

@implementation FBOneViewController
-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];

    [self loadRequestData];
}
-(void)loadRequestData{
    
    NSString *uid = [USERDEFAULTS objectForKey:Y_Zhanghao];
    [WebRequest User_GetGroupsInfoWithuid:uid And:^(NSDictionary *dic) {
        [tarr removeAllObjects];
        NSNumber *number =dic[@"status"];
        NSArray *arr =dic[@"items"];
        if ([number integerValue]==200 ) {
            if(arr.count)
            {
                for (NSDictionary *dic1 in arr) {
                    QunModel *model = [QunModel mj_objectWithKeyValues:dic1];
                    [tarr addObject:model];
                    
                }
            }
            dispatch_async(dispatch_get_main_queue(), ^{
                [self.conversationListTableView reloadData];
            });
        }
    }];
    
    
}
- (void)viewDidLoad {
    [super viewDidLoad];
    self.navigationController.navigationBarHidden=NO;
    tarr = [NSMutableArray arrayWithCapacity:0];
    self.navigationItem.title =@"消息";
    [self setDisplayConversationTypes:@[@(ConversationType_PRIVATE),@(ConversationType_GROUP)]];
    
    [RCIM sharedRCIM].receiveMessageDelegate=self;
    
    
}
- (void)onRCIMReceiveMessage:(RCMessage *)message
                        left:(int)left
{
   int unread_num= [[RCIMClient sharedRCIMClient] getUnreadCount:@[@(ConversationType_PRIVATE),@(ConversationType_GROUP)]];
    
    if (unread_num==0) {
        dispatch_async(dispatch_get_main_queue(), ^{
            self.tabBarItem.badgeValue=nil;
        });
        
    }
    else
    {
        dispatch_async(dispatch_get_main_queue(), ^{
           self.tabBarItem.badgeValue = [NSString stringWithFormat:@"%d",unread_num];
        });
   
    }
}

-(void)onSelectedTableRow:(RCConversationModelType)conversationModelType conversationModel:(RCConversationModel *)model atIndexPath:(NSIndexPath *)indexPath
{
    
    NSString *messagenum = self.tabBarItem.badgeValue;
    
    NSInteger  unread = [messagenum integerValue]-model.unreadMessageCount;
    if (unread > 0) {
        self.tabBarItem.badgeValue = [NSString stringWithFormat:@"%ld",(long)unread];
    }
    else
    {
        self.tabBarItem.badgeValue=nil;
    }
    
    if (model.conversationType == ConversationType_PRIVATE) {
        FBConversationViewControllerViewController *conversationVC = [[FBConversationViewControllerViewController alloc]init];
        conversationVC.conversationType = model.conversationType;
        conversationVC.targetId = model.targetId;
        conversationVC.navigationItem.title = model.conversationTitle;
        conversationVC.hidesBottomBarWhenPushed =YES;
        [self.navigationController pushViewController:conversationVC animated:NO];
    }
    if (model.conversationType == ConversationType_GROUP) {

        FBQunChatViewController *QunVc =[[FBQunChatViewController alloc]init];
        QunVc.conversationType = model.conversationType;
        QunVc.targetId =model.targetId;
        QunVc.navigationItem.title = model.conversationTitle;
        QunVc.hidesBottomBarWhenPushed =YES;
        [self.navigationController pushViewController:QunVc animated:NO];
        
    }
    
    
    
   
}
-(void)didReceiveMessageNotification:(NSNotification *)notification
{
    [super didReceiveMessageNotification:notification];
  
}

- (void)willDisplayConversationTableCell:(RCConversationBaseCell *)cell
                             atIndexPath:(NSIndexPath *)indexPath{
    [super willDisplayConversationTableCell:cell atIndexPath:indexPath];
    
    
    
    RCConversationCell *cell1 =(RCConversationCell*)cell;
    RCConversationModel  *model1 = cell1.model;
    if (model1.conversationType == ConversationType_PRIVATE) {
        
    }
    else
    {
    if (tarr.count) {
        NSPredicate *predicate =[NSPredicate predicateWithFormat:@"groupid CONTAINS[cd] %@",cell.model.targetId];
        NSArray *arr = [NSMutableArray arrayWithArray:[tarr filteredArrayUsingPredicate:predicate]];
        if (arr.count) {
            
            QunModel *model = arr[0];
            cell1.conversationTitle.text = model.groupname;
            model1.conversationTitle =model.groupname;
            UIImageView *imageView=(UIImageView *)cell1.headerImageView;
            dispatch_async(dispatch_get_main_queue(), ^{
                [imageView setImageWithURL:[NSURL URLWithString:model.groupphoto] placeholderImage:[UIImage imageNamed:@"qun"]];
 
            });
            
            
        }
        }
    }
  //增加长按操作
    FBindexpathLongPressGestureRecognizer *longPress = [[FBindexpathLongPressGestureRecognizer alloc]initWithTarget:self action:@selector(longPressClick:)];
    longPress.indexPath = indexPath;
    [cell1 addGestureRecognizer:longPress];
    
    
}
-(void)longPressClick:(FBindexpathLongPressGestureRecognizer*)press
{
    RCConversationModel *model = self.conversationListDataSource[press.indexPath.row];
    
    UIAlertController *alert = [[UIAlertController alloc]init];
    [alert addAction:[UIAlertAction actionWithTitle:@"发任务" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        
    }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"置顶该会话" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        RCConversationModel *model2 = self.conversationListDataSource[0];
        model2.isTop=NO;
        [self.conversationListDataSource removeObject:model];
        [self.conversationListDataSource insertObject:model atIndex:0];
        model.isTop=YES;
        
        [self.conversationListTableView reloadData];
    }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"删除该会话" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        [self.conversationListDataSource removeObject:model];
        
         [self.conversationListTableView reloadData];
        
    }]];
    [alert addAction:[UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
        
    }]];
    [self presentViewController:alert animated:NO completion:nil];
    
}
#pragma mark ---点击头像后的操作
-(void)didTapCellPortrait:(RCConversationModel *)model
{
    //点击头像
    [super didTapCellPortrait:model];
    
}
-(void)didLongPressCellPortrait:(RCConversationModel *)model
{
    //长按头像
    [super didLongPressCellPortrait:model];
    
}

@end
