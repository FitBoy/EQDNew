//
//  FBScrollView.m
//  YiQiDian
//
//  Created by 梁新帅 on 2017/2/13.
//  Copyright © 2017年 FitBoy. All rights reserved.
//
#define DEVICE_HEIGHT  [UIScreen mainScreen].bounds.size.height
#define DEVICE_WIDTH   [UIScreen mainScreen].bounds.size.width
#import "FBScrollView.h"
#import <UIButton+AFNetworking.h>
@implementation FBScrollView
-(instancetype)initWithFrame:(CGRect)frame imgs:(NSArray<NSString*>*)imgArr{
    if (self =[super initWithFrame:frame]) {
        self.scrollV =[[UIScrollView alloc]initWithFrame:CGRectMake(0, 0, frame.size.width, frame.size.height)];
        [self addSubview:self.scrollV];
        self.scrollV.contentSize = CGSizeMake(frame.size.width*imgArr.count, frame.size.height);
        _arr_btn = [NSMutableArray arrayWithCapacity:0];
        for (int i=0; i<imgArr.count; i++) {
            UIButton *btn =[UIButton buttonWithType:UIButtonTypeSystem];
            btn.frame = CGRectMake(frame.size.width*i, 0, frame.size.width, frame.size.height);
            [self.scrollV addSubview:btn];
            [btn setBackgroundImage:[UIImage imageNamed:imgArr[i]] forState:UIControlStateNormal];
//            NSString *str =imgArr[i];
//            str =[str stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceAndNewlineCharacterSet]];
//            [btn setBackgroundImageForState:UIControlStateNormal withURL:[NSURL URLWithString:str]];
            
            btn.tag =2200+i;
            [btn addTarget:self action:@selector(btnClick:) forControlEvents:UIControlEventTouchUpInside];
            [_arr_btn addObject:btn];
        }
        self.scrollV.pagingEnabled =YES;
        self.scrollV.delegate =self;
        
       self.pageControl =[[UIPageControl alloc]initWithFrame:CGRectMake(0, frame.size.height-20, frame.size.width, 20)];
        [self addSubview:self.pageControl];
        self.pageControl.numberOfPages =imgArr.count;
        [self.pageControl addTarget:self action:@selector(pageChoose) forControlEvents:UIControlEventTouchUpInside];
        self.pageControl.pageIndicatorTintColor = [UIColor greenColor];
        __block total =0;
        //全局并发队列
        dispatch_queue_t globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
        //主队列；属于串行队列
        dispatch_queue_t mainQueue = dispatch_get_main_queue();
        
        //定时循环执行事件
        
        dispatch_source_t  timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, globalQueue);
        dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 2.0 * NSEC_PER_SEC, 0.0 * NSEC_PER_SEC);
        dispatch_source_set_event_handler(timer, ^{
            total=total%imgArr.count;
            if (total <0) {
                dispatch_source_cancel(timer);
            }
            else{
                dispatch_async(dispatch_get_main_queue(), ^{
//                    [self.scrollV setContentOffset:CGPointMake(DEVICE_WIDTH*total, 0)];
                    [self.scrollV setContentOffset:CGPointMake(DEVICE_WIDTH*total, 0) animated:YES];
                    self.pageControl.currentPage=total;
                    total ++;
                });
                
                
            }
        });
        dispatch_source_set_cancel_handler(timer, ^{
            NSLog(@"Cancel Handler");
        });
        dispatch_resume(timer);
        
    }
    return self;
}

-(void)btnClick:(UIButton*)btn{
    NSLog(@"=滚动图===%ld",btn.tag);
}
-(void)pageChoose{
    [self.scrollV setContentOffset:CGPointMake(DEVICE_WIDTH*self.pageControl.currentPage, 0)];
    
}

- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView{
    self.pageControl.currentPage = (NSInteger)scrollView.contentOffset.x/DEVICE_WIDTH;
    
}


@end
